@page "/"

@using System.Text.Json
@using KustoPlayground.Core
@inject KustoDatabase KustoDatabase

<h3>Add Kusto table</h3>

<!-- Tab buttons -->
<div style="margin-bottom:10px;">
    <button style="@(ActiveTab == "CSV" ? "font-weight:bold;" : "")" @onclick="@(() => ActiveTab = "CSV")">CSV</button>
    <button style="@(ActiveTab == "JSON" ? "font-weight:bold;" : "")" @onclick="@(() => ActiveTab = "JSON")">JSON
    </button>
</div>

@if (ActiveTab == "CSV")
{
    <label for="csvData">CSV data:</label>
    <br/>
    <textarea id="csvData" @bind="CsvText" rows="6" cols="60" placeholder="Paste CSV header and rows here"></textarea>
    <br/>
    <br/>
    <label for="tableName">Table name:</label>
    <br/>
    <input id="tableName" @bind="CsvTableName" placeholder="Table name (e.g., MyTable)"/>
    <br/>
    <button @onclick="ProcessCsv">Add Table</button>

    @if (CsvAdded)
    {
        <p><em>CSV table "@CsvTableName" added successfully.</em></p>
    }
}

@if (ActiveTab == "JSON")
{
    <label for="jsonData">JSON table representation:</label>
    <br/>
    <textarea id="jsonData" @bind="JsonText" rows="6" cols="60"
              placeholder="Paste JSON table representation"></textarea>
    <br/>
    <button @onclick="ProcessJson">Add Table</button>

    @if (JsonAdded)
    {
        <p><em>JSON table added successfully.</em></p>
    }
}

<hr/>

<h3>Kusto Processor</h3>

<textarea @bind="KqlQuery" rows="10" cols="60"></textarea>
<br/>
<button @onclick="ExecuteKusto">Process Kusto Query</button>

@if (Results.Any())
{
    <h4>Results</h4>
    <ul>
        @foreach (var line in Results)
        {
            <li>@line</li>
        }
    </ul>
}

@if (Errors.Any())
{
    <h4 style="color: red;">Errors</h4>
    <ul>
        @foreach (var line in Errors)
        {
            <li>@line</li>
        }
    </ul>
}

@code {
    private string ActiveTab { get; set; } = "CSV";

    // CSV state
    private string CsvText { get; set; } = @"DamageProperty,StartTime,State,EventType
20000,8/23/2025 6:20:00 AM,FLORIDA,Hurricane
5000,3/28/2023 10:30:00 AM,TEXAS,Flood
5000,6/1/2024 4:50:30 PM,FLORIDA,Tornado
";

    private string CsvTableName { get; set; } = "StormEvents";
    private bool CsvAdded { get; set; }

    // JSON state
    private string JsonText { get; set; } = @"{
  ""Name"": ""StormEvents"",
  ""Columns"": [
    { ""Name"": ""StartTime"", ""Type"": ""DateTime"", ""Nullable"": false },
    { ""Name"": ""State"", ""Type"": ""string"", ""Nullable"": false },
    { ""Name"": ""EventType"", ""Type"": ""string"", ""Nullable"": true },
    { ""Name"": ""DamageProperty"", ""Type"": ""int"", ""Nullable"": false }
  ],
  ""Rows"": [
    {
      ""StartTime"": ""2025-08-23T06:20:00"",
      ""State"": ""FLORIDA"",
      ""EventType"": ""Hurricane"",
      ""DamageProperty"": 20000
    },
    {
      ""StartTime"": ""08/28/2025 09:49 AM"",
      ""State"": ""TEXAS"",
      ""EventType"": ""Tornado"",
      ""DamageProperty"": 5000
    }
  ]
}
";

    private bool JsonAdded { get; set; }

    // Query state
    private string KqlQuery { get; set; } = @"StormEvents
    | where State == 'FLORIDA' and DamageProperty > 10000
    | project StartTime, EventType, DamageProperty
    | take 10
";

    private List<string> Results { get; set; } = new();

    private List<string> Errors { get; set; } = new();

    private void ProcessCsv()
    {
        if (string.IsNullOrWhiteSpace(CsvText) || string.IsNullOrWhiteSpace(CsvTableName))
        {
            return;
        }

        var lines = CsvText.Split('\n', StringSplitOptions.RemoveEmptyEntries)
            .Select(l => l.Trim())
            .ToList();

        if (lines.Count < 2)
        {
            return;
        }

        var headers = lines[0].Split(',').Select(h => h.Trim()).ToList();

        var rows = lines.Skip(1)
            .Select(line => line.Split(',')
                .Select((val, idx) => new KeyValuePair<string, object?>(headers[idx], val.Trim()))
                .ToDictionary(kv => kv.Key, kv => kv.Value))
            .ToList();

        Table newTable = TableBuilderFromCsv.Build(new TableDef
        {
            Name = CsvTableName,
            Columns = headers.Select(header => new ColumnDef { Name = header }).ToList(),
            Rows = rows
        });

        KustoDatabase.AddTable(newTable);
        CsvAdded = true;
        JsonAdded = false;
        Results = new();
        Errors = new();
    }

    private void ProcessJson()
    {
        if (string.IsNullOrWhiteSpace(JsonText))
        {
            return;
        }

        TableDef? tableDef = JsonSerializer.Deserialize<TableDef>(JsonText);
        Table table = TableBuilderFromJson.Build(tableDef!);

        KustoDatabase.AddTable(table);
        JsonAdded = true;
        CsvAdded = false;
        Results = new List<string>();
        Errors = new List<string>();
    }

    private void ExecuteKusto()
    {
        Results = new List<string>();
        Errors = new List<string>();

        JsonAdded = false;
        CsvAdded = false;

        var executeResults = KustoDatabase.ExecuteQuery(KqlQuery);

        if (executeResults.ResultRows != null)
        {
            Results = executeResults.ResultRows
                .Select(row =>
                    string.Join(", ", row.Select(kv => $"{kv.Key}={kv.Value}")))
                .ToList();

            if (Results.Count == 0)
            {
                Results.Add("Empty result");
            }
        }

        if (executeResults.ExecutionErrors != null)
        {
            Errors = executeResults.ExecutionErrors
                .Select(error => $"{error.Code} -- {error.Description}")
                .ToList();
        }
    }

}
